name: "Secrets Sync - Artifactory NPM"

on:
  workflow_dispatch:
  push:
    branches:
      - master
    paths:
      - '.github/workflows/secret-sync-artifactory-npm.yaml' # Repository/Environment Secrets
      - '.github/secret-sync-artifactory-npm.yaml' # Dependabot Secrets

jobs:
  syncSecrets:
    name: "Sync Github Secrets to Repos"
    runs-on: ubuntu-latest
    steps:
      # WMS Jfrog (Cloud) Artifactory Credentials (Old Secret Name)
      - name: Secrets Sync - Artifactory - NPM
        uses: google/secrets-sync-action@v1.7.1
        with:
          SECRETS: |
            ^secret_sync
          REPOSITORIES: |
            RaptorDVZ/testing
            RaptorDVZ/myfile
          DRY_RUN: false
          CONCURRENCY: 2
          repositories_list_regex: false
        env:
          secret_sync: ${{ secrets.secret_sync }}
      # For as long as Google doesn't support Dependabot Secrets
      - name: Checkout Code
        uses: actions/checkout@v3
      - name: xt0rted Secrets Sync - Artifactory NPM
        uses: xt0rted/secrets-sync@v1
        with:
          config: .github/secret-sync-artifactory-npm.yaml
        env:
          secret_sync: ${{ secrets.secret_sync }}
      - name: Publish Failure Card
        uses: toko-bifrost/ms-teams-deploy-card@3.1.2
        if: failure()
        with:
          github-token: ${{ github.token }}
          webhook-uri: ${{ secrets.TEAMS_WMSPD_SYSTEMS_TEAM_GITHUBACTIONSNOTIFIY_WEBHOOK_URL }}
          show-on-start: false
          show-on-failure: true
          card-layout-exit: complete
          custom-facts: |
            - name: Failure Action
              value: "There is a failure with the new changes please resolve"